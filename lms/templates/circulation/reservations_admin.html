{% extends "base.html" %}
{% block title %}Manage Reservations | LibraryMS{% endblock %}
{% block content %}

<div class="flex items-center justify-between mb-6">
  <h1 class="text-lg font-semibold text-gray-800">Manage Reservations</h1>
  <p class="text-xs text-gray-500">Librarian Dashboard</p>
</div>

<!-- Pending Reservations -->
<div class="border rounded-lg bg-white shadow-sm overflow-hidden mb-8">
  <div class="flex items-center justify-between border-b px-4 py-3 bg-gray-50">
    <h2 class="text-sm font-medium text-gray-700">Pending Reservations</h2>
    <span id="pendingCount" class="text-xs text-gray-500">{{ pending|length }} pending</span>
  </div>

  {% if pending %}
  <div class="overflow-x-auto" id="tableWrapper">
    <table class="min-w-full text-sm text-left" id="reservationsTable">
      <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide">
        <tr>
          <th class="px-4 py-2">Book</th>
          <th class="px-4 py-2">Member</th>
          <th class="px-4 py-2">Requested On</th>
          <th class="px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for r in pending %}
        <tr id="row-{{ r.id }}" class="hover:bg-gray-50">
          <td class="px-4 py-2 font-medium text-gray-800">{{ r.book.title }}</td>
          <td class="px-4 py-2 text-gray-600">{{ r.member.first_name }} {{ r.member.last_name }}</td>
          <td class="px-4 py-2 text-gray-600">{{ r.created_at.strftime('%d %b %Y') }}</td>
          <td class="px-4 py-2">
            <div class="flex gap-2">
              <button type="button"
                      class="approveBtn px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-100"
                      data-res-id="{{ r.id }}"
                      data-book="{{ r.book.title }}"
                      data-member="{{ r.member.first_name }} {{ r.member.last_name }}">
                Approve
              </button>
              <button type="button"
                      class="cancelBtn px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-100"
                      data-res-id="{{ r.id }}"
                      data-book="{{ r.book.title }}"
                      data-member="{{ r.member.first_name }} {{ r.member.last_name }}">
                Cancel
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p id="emptyMessage" class="text-sm text-gray-500 px-4 py-6 text-center">No pending reservations.</p>
  {% endif %}
</div>

<!-- Ready for Pickup -->
<div class="border rounded-lg bg-white shadow-sm overflow-hidden" id="readySection">
  <div class="flex items-center justify-between border-b px-4 py-3 bg-gray-50">
    <h2 class="text-sm font-medium text-gray-700">Ready for Pickup</h2>
    <span id="readyCount" class="text-xs text-gray-500">{{ ready|length if ready else 0 }} ready</span>
  </div>

  {% if ready %}
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left" id="readyTable">
      <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide">
        <tr>
          <th class="px-4 py-2">Book</th>
          <th class="px-4 py-2">Member</th>
          <th class="px-4 py-2">Pickup By</th>
          <th class="px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for r in ready %}
        <tr id="ready-{{ r.id }}" class="hover:bg-gray-50">
          <td class="px-4 py-2 font-medium text-gray-800">{{ r.book.title }}</td>
          <td class="px-4 py-2 text-gray-600">{{ r.member.first_name }} {{ r.member.last_name }}</td>
          <td class="px-4 py-2 text-gray-600">{{ r.pickup_by.strftime('%d %b %Y') if r.pickup_by else '-' }}</td>
          <td class="px-4 py-2">
            <button type="button"
                    class="collectBtn px-3 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-100"
                    data-res-id="{{ r.id }}"
                    data-book="{{ r.book.title }}"
                    data-member="{{ r.member.first_name }} {{ r.member.last_name }}">
              Mark as Collected
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p id="readyEmpty" class="text-sm text-gray-500 px-4 py-6 text-center">No books ready for pickup yet.</p>
  {% endif %}
</div>

<!-- ================== MODALS ================== -->
<!-- Collect Modal -->
<div id="collectModal"
     class="hidden fixed inset-0 bg-gray-600/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
    <h3 class="text-base font-semibold text-gray-800 mb-2">Mark as Collected</h3>
    <p class="text-sm text-gray-600 mb-4">
      Confirm that <span id="collectMember" class="font-medium text-gray-800"></span> has collected<br>
      <span id="collectBook" class="font-medium text-gray-800"></span>
    </p>
    <div class="flex justify-end gap-2">
      <button type="button" id="cancelCollect"
              class="px-3 py-1.5 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-100">
        Cancel
      </button>
      <button id="confirmCollect"
              class="px-3 py-1.5 rounded text-xs text-white bg-gray-800 hover:bg-gray-700">
        Confirm
      </button>
    </div>
  </div>
</div>

<!-- âœ… Receipt Modal -->
<div id="receiptModal"
     class="hidden fixed inset-0 bg-gray-600/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 text-center">
    <div class="flex flex-col items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-green-600 mb-2" fill="none" viewBox="0 0 24 24"
           stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5 13l4 4L19 7" />
      </svg>
      <h3 class="text-base font-semibold text-gray-800 mb-1">Book Issued Successfully</h3>
      <p class="text-xs text-gray-500 mb-4">A new loan record has been created.</p>
    </div>
    <div id="receiptContent" class="border-t border-gray-200 pt-3 text-sm text-gray-700">
      <p><span class="font-medium">Book:</span> <span id="receiptBook"></span></p>
      <p><span class="font-medium">Member:</span> <span id="receiptMember"></span></p>
      <p><span class="font-medium">Issue Date:</span> <span id="receiptIssue"></span></p>
      <p><span class="font-medium">Due Date:</span> <span id="receiptDue"></span></p>
    </div>
    <div class="flex justify-center mt-5 gap-3">
      <button id="closeReceipt"
              class="px-4 py-1.5 text-xs rounded bg-gray-800 text-white hover:bg-gray-700">
        Close
      </button>
      <button id="downloadPDF"
              class="px-4 py-1.5 text-xs rounded border border-gray-400 text-gray-700 hover:bg-gray-100">
        Download PDF
      </button>
    </div>
  </div>
</div>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const collectModal = document.getElementById("collectModal");
  const receiptModal = document.getElementById("receiptModal");
  const collectBtns = document.querySelectorAll(".collectBtn");
  const readyCount = document.getElementById("readyCount");

  const receiptBook = document.getElementById("receiptBook");
  const receiptMember = document.getElementById("receiptMember");
  const receiptIssue = document.getElementById("receiptIssue");
  const receiptDue = document.getElementById("receiptDue");

  collectBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      currentResId = btn.dataset.resId;
      document.getElementById("collectBook").textContent = btn.dataset.book;
      document.getElementById("collectMember").textContent = btn.dataset.member;
      collectModal.classList.remove("hidden");
    });
  });

  document.getElementById("cancelCollect").addEventListener("click", () => collectModal.classList.add("hidden"));
  document.getElementById("confirmCollect").addEventListener("click", async () => {
    await handleCollectAction(currentResId);
    collectModal.classList.add("hidden");
  });

  document.getElementById("closeReceipt").addEventListener("click", () => receiptModal.classList.add("hidden"));

  document.getElementById("downloadPDF").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" }); // 72pt/in

    // ---------- Page metrics ----------
    const page = { w: doc.internal.pageSize.getWidth(), h: doc.internal.pageSize.getHeight() };
    const margin = 48; // 2/3 inch
    let y = margin;

    // ---------- Colors & fonts ----------
    const gray = [60, 60, 60];
    const lightGray = [200, 200, 200];
    doc.setTextColor(...gray);
    doc.setFont("helvetica", "normal");

    // ---------- Header with "logo" ----------
    // Fake logo: a small rounded square with "LM"
    const logoX = margin, logoY = y, logoSize = 34;
    doc.setDrawColor(30, 30, 30);
    doc.setFillColor(245, 245, 245);
    doc.roundedRect(logoX, logoY, logoSize, logoSize, 6, 6, "FD");
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("LM", logoX + logoSize / 2, logoY + logoSize / 2 + 5, { align: "center" });

    // Library name + address
    doc.setFontSize(16);
    doc.text("LibraryMS", logoX + logoSize + 10, y + 14);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text("123 Library Road, Knowledge Park, City 000000", logoX + logoSize + 10, y + 30);
    doc.text("Email: support@libraryms.local | Phone: +91-00000-00000", logoX + logoSize + 10, y + 44);

    // Receipt title + date on the right
    doc.setTextColor(...gray);
    const rightX = page.w - margin;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Loan Receipt", rightX, y + 16, { align: "right" });
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const printedOn = new Date().toLocaleDateString();
    doc.text(`Printed: ${printedOn}`, rightX, y + 30, { align: "right" });

    y += logoSize + 14;

    // ---------- Top divider ----------
    doc.setDrawColor(...lightGray);
    doc.line(margin, y, page.w - margin, y);
    y += 20;

    // ---------- Receipt box ----------
    const boxX = margin, boxW = page.w - margin * 2;
    let boxY = y, lineH = 18;

    // Outer rounded box
    doc.setDrawColor(180, 180, 180);
    doc.roundedRect(boxX, boxY, boxW, 170, 8, 8);

    // Labels & values (from DOM)
    const book = document.getElementById("receiptBook").textContent || "-";
    const member = document.getElementById("receiptMember").textContent || "-";
    const issue = document.getElementById("receiptIssue").textContent || "-";
    const due = document.getElementById("receiptDue").textContent || "-";

    // Left column
    doc.setFont("helvetica", "bold"); doc.setFontSize(11);
    doc.text("Book", boxX + 14, boxY + 24);
    doc.text("Member", boxX + 14, boxY + 24 + lineH);
    doc.text("Issue Date", boxX + 14, boxY + 24 + lineH * 2);
    doc.text("Due Date", boxX + 14, boxY + 24 + lineH * 3);

    // Right column values
    doc.setFont("helvetica", "normal");
    doc.setTextColor(40, 40, 40);
    const valX = boxX + 120;
    doc.text(book, valX, boxY + 24);
    doc.text(member, valX, boxY + 24 + lineH);
    doc.text(issue, valX, boxY + 24 + lineH * 2);
    doc.text(due, valX, boxY + 24 + lineH * 3);

    // Inner divider line
    doc.setDrawColor(230, 230, 230);
    doc.line(boxX + 12, boxY + 24 + lineH * 3 + 10, boxX + boxW - 12, boxY + 24 + lineH * 3 + 10);

    // Friendly message
    doc.setFont("helvetica", "italic"); doc.setFontSize(10);
    doc.setTextColor(90, 90, 90);
    doc.text("Please keep this slip for your records. Return on or before the due date to avoid fines.", boxX + 14, boxY + 24 + lineH * 4 + 18);

    y = boxY + 170 + 24;

    // ---------- Footer note ----------
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(120, 120, 120);
    doc.text("Terms: Items returned late may incur fines per library policy. Handle books with care.", margin, page.h - margin - 20);
    doc.text("Â© LibraryMS â€” Empowering reading & research", margin, page.h - margin - 8);

    // ---------- Save ----------
    // Sanitize filename a bit
    const safeBook = book.replace(/[^\w\d]+/g, "_").slice(0, 40) || "Book";
    doc.save(`Loan_Receipt_${safeBook}.pdf`);
  });

  async function handleCollectAction(id) {
    const endpoint = `/reservations/${id}/collect`;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken || "",
        }
      });
      const data = await response.json();
      if (response.ok) {
        const row = document.getElementById(`ready-${id}`);
        if (row) row.remove();
        const remaining = document.querySelectorAll("#readyTable tbody tr").length;
        readyCount.textContent = `${remaining} ready`;

        receiptBook.textContent = data.book;
        receiptMember.textContent = data.member;
        receiptIssue.textContent = data.issue_date;
        receiptDue.textContent = data.due_date;
        receiptModal.classList.remove("hidden");
      } else {
        showToast(data.error || "Error marking as collected.", true);
      }
    } catch (err) {
      showToast(err.message, true);
    }
  }

  function showToast(msg, isError = false) {
    const toast = document.createElement("div");
    toast.textContent = msg;
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded text-sm shadow-md ${
      isError ? "bg-red-600 text-white" : "bg-gray-800 text-white"
    }`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  }

  [collectModal, receiptModal].forEach(modal => {
    modal.addEventListener("click", e => {
      if (e.target === modal) modal.classList.add("hidden");
    });
  });
});
</script>

{% endblock %}