{% extends "base.html" %}
{% block title %}Issued Books | LibraryMS{% endblock %}
{% block content %}

<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
  <h1 class="text-lg font-semibold text-gray-800">Issued Books</h1>
  <form method="get" class="flex gap-2 text-sm">
    <input name="q" value="{{ request.args.get('q','') }}"
           placeholder="Search by member or title"
           class="border border-gray-300 rounded px-3 py-1.5 text-sm w-60 focus:ring-1 focus:ring-gray-800">
    <select name="status"
            class="border border-gray-300 rounded px-3 py-1.5 text-sm text-gray-700">
      <option value="">All</option>
      <option value="active" {% if request.args.get('status')=='active' %}selected{% endif %}>Active</option>
      <option value="overdue" {% if request.args.get('status')=='overdue' %}selected{% endif %}>Overdue</option>
      <option value="returned" {% if request.args.get('status')=='returned' %}selected{% endif %}>Returned</option>
    </select>
    <button class="px-3 py-1.5 bg-gray-900 text-white rounded text-xs hover:bg-gray-800">Search</button>
  </form>
</div>

<!-- Table -->
<div class="border rounded-lg bg-white shadow-sm overflow-x-auto">
  <table class="min-w-full text-sm text-left">
    <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide">
      <tr>
        <th class="px-4 py-2">Member</th>
        <th class="px-4 py-2">Book</th>
        <th class="px-4 py-2">Copy</th>
        <th class="px-4 py-2">Issued</th>
        <th class="px-4 py-2">Due</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2 text-right">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% if loans %}
        {% for loan in loans %}
        {% set overdue = loan.due_date and (loan.due_date < now_utc) and loan.status == 'issued' %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2 text-gray-800">{{ loan.member.first_name }} {{ loan.member.last_name }}</td>
          <td class="px-4 py-2 text-gray-700">{{ loan.copy.book.title }}</td>
          <td class="px-4 py-2 text-gray-600">{{ loan.copy.barcode }}</td>
          <td class="px-4 py-2 text-gray-600">{{ loan.issued_at.strftime('%d %b %Y') }}</td>
          <td class="px-4 py-2 text-gray-600">{{ loan.due_date.strftime('%d %b %Y') if loan.due_date else '-' }}</td>
          <td class="px-4 py-2">
            {% if loan.status == 'returned' %}
              <span class="text-[10px] px-2 py-1 rounded bg-gray-200 text-gray-700">Returned</span>
            {% elif overdue %}
              <span class="text-[10px] px-2 py-1 rounded bg-red-100 text-red-700">Overdue</span>
            {% else %}
              <span class="text-[10px] px-2 py-1 rounded bg-green-100 text-green-700">Issued</span>
            {% endif %}
          </td>
          <td class="px-4 py-2">
            <div class="flex items-center gap-2 justify-end">
              {% if loan.status == 'issued' %}
                <button type="button"
                        class="px-2 py-1 border border-gray-300 rounded text-xs text-gray-700 hover:bg-gray-100 openReturn"
                        data-loan-id="{{ loan.id }}"
                        data-member="{{ loan.member.first_name }} {{ loan.member.last_name }}"
                        data-book="{{ loan.copy.book.title }}"
                        data-barcode="{{ loan.copy.barcode }}"
                        data-due="{{ loan.due_date.strftime('%Y-%m-%d') if loan.due_date else '' }}">
                  Return
                </button>
              {% else %}
                <span class="text-[10px] text-gray-400">—</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="px-4 py-8 text-center text-sm text-gray-500">No issued books found.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Return Book Modal -->
<div id="returnModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg mx-4 overflow-hidden">
    <div class="flex items-center justify-between border-b px-4 py-3 bg-gray-50">
      <h3 class="text-sm font-medium text-gray-700">Return Book</h3>
      <button class="text-gray-500 hover:text-gray-700 modal-close">✕</button>
    </div>
    <form method="post" action="{{ url_for('circulation.return_book') }}" class="p-4 space-y-3">
      {{ csrf_token() if csrf_token }}
      <input type="hidden" name="loan_id" id="loan_id">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Member</label>
        <input id="r_member" readonly class="w-full border border-gray-200 rounded px-3 py-2 text-sm bg-gray-50">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Book / Copy</label>
        <input id="r_book" readonly class="w-full border border-gray-200 rounded px-3 py-2 text-sm bg-gray-50">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Due Date</label>
        <input id="r_due" readonly class="w-full border border-gray-200 rounded px-3 py-2 text-sm bg-gray-50">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Return Date</label>
        <input type="date" name="return_date" value="{{ today }}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Fine (if any)</label>
        <input type="number" step="0.01" name="fine" placeholder="0.00"
               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Condition Notes</label>
        <input type="text" name="notes" placeholder="Condition, remarks..."
               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
      </div>
      <div class="flex justify-end gap-2 pt-2 border-t">
        <button type="button" class="px-3 py-1.5 text-xs border border-gray-300 rounded text-gray-700 hover:bg-gray-100 modal-close">Cancel</button>
        <button class="px-3 py-1.5 text-xs bg-gray-900 text-white rounded hover:bg-gray-800">Confirm Return</button>
      </div>
    </form>
  </div>
</div>

<script>
  function open(el){ el?.classList.remove('hidden'); el?.classList.add('flex'); }
  function close(el){ el?.classList.add('hidden'); el?.classList.remove('flex'); }

  const modal = document.getElementById('returnModal');
  const loanInput = document.getElementById('loan_id');
  const rMember = document.getElementById('r_member');
  const rBook = document.getElementById('r_book');
  const rDue = document.getElementById('r_due');

  // Return buttons
  document.querySelectorAll('.openReturn').forEach(btn => {
    btn.addEventListener('click', () => {
      loanInput.value = btn.dataset.loanId;
      rMember.value = btn.dataset.member;
      rBook.value = `${btn.dataset.book} (${btn.dataset.barcode})`;
      rDue.value = btn.dataset.due || '-';
      open(modal);
    });
  });

  // Close buttons
  document.querySelectorAll('.modal-close').forEach(x => {
    x.addEventListener('click', () => close(x.closest('#returnModal')));
  });
  modal?.addEventListener('click', (e) => { if (e.target === modal) close(modal); });
</script>

{% endblock %}